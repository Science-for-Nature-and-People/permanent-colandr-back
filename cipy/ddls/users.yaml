---
schema:
    table_name: "users"
    columns:
        -
            column_name: "user_id"
            data_type: "SERIAL"
            column_constraints: "PRIMARY KEY"
        -
            column_name: "created_ts"
            data_type: "TIMESTAMP(0) WITHOUT TIME ZONE"
            column_constraints: "NOT NULL"
        -
            column_name: "name"
            data_type: "VARCHAR(200)"
            column_constraints: "NOT NULL"
        -
            column_name: "email"
            data_type: "VARCHAR(200)"
            column_constraints: "NOT NULL"
        -
            column_name: "password"
            data_type: "VARCHAR"
            column_constraints: "NOT NULL"
        -
            column_name: "project_ids"
            data_type: "INTEGER ARRAY"
        -
            column_name: "owned_project_ids"
            data_type: "INTEGER ARRAY"
templates:
    create_user: >
        INSERT INTO users (created_ts, name, email, password)
        VALUES (%(created_ts)s, %(name)s, %(email)s, crypt(%(password)s, gen_salt('bf')))
        RETURNING user_id
    delete_user: >
        DELETE from users
        WHERE user_id = %(user_id)s
        RETURNING user_id
    login_user: >
        SELECT user_id, name, project_ids, owned_project_ids
        FROM users
        WHERE
            email = %(email)s
            AND crypt(%(password)s, password) = password
    add_created_project: >
        UPDATE users
        SET
            owned_project_ids = uniq(sort(array_append(owned_project_ids, %(project_id)s))),
            project_ids = uniq(sort(array_append(project_ids, %(project_id)s)))
        WHERE user_id = %(user_id)s
        RETURNING user_id
    remove_deleted_project: >
        UPDATE users
        SET
            owned_project_ids = owned_project_ids - %(project_id)s,
            project_ids = project_ids - %(project_id)s
        WHERE %(project_id)s = ANY(project_ids)
        RETURNING user_id
    check_email_exists: >
        SELECT true FROM users WHERE email = %(email)s
...
